{% extends "layout.html" %}
{% block title %}Account · PlayrServers Control Plane{% endblock %}
{% block content %}
<div class="stack">
    <div class="card">
        <h1>Account management</h1>
        <p class="muted">Update your operator profile, rotate credentials, and keep your login password aligned with PlayrServers security policies.</p>
        {% if messages %}
            {% for item in messages %}
                {% set category = item.category if item.category is defined else 'info' %}
                <div class="notice{% if category == 'error' %} danger{% elif category == 'success' %} success{% endif %}">{{ item.message }}</div>
            {% endfor %}
        {% endif %}
        <div class="grid-2">
            <section>
                <h2>Profile details</h2>
                <form method="post" action="{{ request.url_for('update_profile') }}">
                    <div class="field">
                        <label for="name">Display name</label>
                        <input type="text" id="name" name="name" value="{{ user.name }}" required>
                    </div>
                    <div class="field">
                        <label for="email">Email address</label>
                        <input type="email" id="email" name="email" value="{{ user.email or '' }}" placeholder="you@example.com">
                        <p class="help-text">Used for sign-in notifications. Leave blank to detach an email address.</p>
                    </div>
                    <button type="submit" class="button">Save changes</button>
                </form>
            </section>
            <section>
                <h2>Password</h2>
                <form method="post" action="{{ request.url_for('change_password') }}">
                    <div class="field">
                        <label for="current_password">Current password</label>
                        <input type="password" id="current_password" name="current_password" required autocomplete="current-password">
                    </div>
                    <div class="field">
                        <label for="new_password">New password</label>
                        <input type="password" id="new_password" name="new_password" required autocomplete="new-password" minlength="{{ password_min_length }}">
                        <p class="help-text">Minimum {{ password_min_length }} characters. Choose a phrase unique to this control plane.</p>
                    </div>
                    <div class="field">
                        <label for="confirm_password">Confirm new password</label>
                        <input type="password" id="confirm_password" name="confirm_password" required autocomplete="new-password">
                    </div>
                    <button type="submit" class="button secondary">Update password</button>
                </form>
            </section>
        </div>
    </div>

    <div class="card">
        <div class="section-header">
            <h2>Automation API key</h2>
            <span class="badge">Prefix: {{ user.api_key_prefix }}</span>
        </div>
        <p class="muted">Remote agents authenticate with this key when calling <code>{{ api_base_url }}</code>. Rotate immediately if you suspect a compromise.</p>
        {% set visible_api_key = revealed_api_key or generated_api_key %}
        <div class="notice warning">
            <p><strong>Protect this secret.</strong> Anyone with the full API key can manage your hypervisors. Reveal it only in a trusted environment and rotate immediately if you suspect exposure.</p>
        </div>
        <div class="notice">
            <p><strong>API endpoint:</strong> <code>{{ api_base_url }}</code></p>
            <p><strong>Current key prefix:</strong> <code>{{ user.api_key_prefix }}</code></p>
        </div>
        {% if visible_api_key %}
            <div class="notice danger">
                <p><strong>Full API key:</strong></p>
                <pre><code>{{ visible_api_key }}</code></pre>
                {% if revealed_api_key %}
                    <p class="help-text">Rotate the credential if this value was displayed somewhere unsafe.</p>
                {% else %}
                    <p class="help-text">Copy the token now—this is the only time it will be displayed after rotation.</p>
                {% endif %}
            </div>
        {% endif %}
        <div class="grid-2">
            <section>
                <h3>Reveal current key</h3>
                <form method="post" action="{{ request.url_for('reveal_api_key') }}">
                    <div class="field">
                        <label for="reveal-password">Account password</label>
                        <input type="password" id="reveal-password" name="password" required autocomplete="current-password">
                    </div>
                    <p class="help-text">Confirm your identity to decrypt and display the existing API key.</p>
                    <button type="submit" class="button secondary">Reveal API key</button>
                </form>
            </section>
            <section>
                <h3>Rotate key</h3>
                <form method="post" action="{{ request.url_for('rotate_api_key') }}">
                    <p class="help-text">Issuing a new key immediately revokes the previous secret.</p>
                    <button type="submit" class="button danger">Rotate API key</button>
                </form>
            </section>
        </div>
        <p style="margin-top: 1.5rem;">Provision the remote agent environment file on your hypervisor:</p>
<pre><code>sudo install -d -m 700 /etc/playrservers
sudo tee /etc/playrservers/agent.env &gt; /dev/null &lt;&lt;'CONFIG'
API_BASE_URL={{ api_base_url }}
API_KEY={{ visible_api_key or '&lt;your-api-key&gt;' }}
CONFIG
sudo chmod 600 /etc/playrservers/agent.env
</code></pre>
        <p>After configuring the environment, restart the agent to trigger pairing:</p>
<pre><code>sudo systemctl restart playrservers-agent
sudo journalctl -u playrservers-agent -n 50
</code></pre>
        <p class="muted">The agent calls <code>POST /v1/servers/connect</code> on startup to register the host using the credentials above.</p>
    </div>
</div>
{% endblock %}
