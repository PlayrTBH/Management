{% extends "base.html" %}

{% block title %}Dashboard · PlayrServers Management{% endblock %}

{% block content %}
<header class="page-head">
  <div class="page-head__content">
    <h1 class="page-head__title">Hypervisors</h1>
    <p class="page-head__subtitle">Monitor the systems paired with your management plane and review their tunnel activity.</p>
    <div class="page-head__metrics">
      <div class="page-head__metric">
        <span class="page-head__metric-value">{{ hypervisor_count }}</span>
        <span class="page-head__metric-label">Paired</span>
      </div>
      <div class="page-head__metric">
        <span class="page-head__metric-value">{{ online_count }}</span>
        <span class="page-head__metric-label">Online now</span>
      </div>
    </div>
  </div>
  <div class="page-head__actions">
    <a class="button button--primary" href="{{ request.url_for('ui_agent_installer') }}">Add hypervisor</a>
  </div>
</header>

<section class="card">
  <h2 class="card__title">Account overview</h2>
  <p class="card__subtitle">Review the details associated with your management account.</p>
  <dl class="detail-grid">
    <div class="detail-grid__item">
      <dt>Name</dt>
      <dd>{{ user.name }}</dd>
    </div>
    <div class="detail-grid__item">
      <dt>Email</dt>
      <dd>{{ user.email or 'Not set' }}</dd>
    </div>
    <div class="detail-grid__item">
      <dt>Created</dt>
      <dd>{{ format_datetime(user.created_at) }}</dd>
    </div>
    <div class="detail-grid__item">
      <dt>Paired hypervisors</dt>
      <dd>{{ hypervisor_count }}</dd>
    </div>
    <div class="detail-grid__item">
      <dt>Online now</dt>
      <dd>{{ online_count }}</dd>
    </div>
  </dl>
</section>

<section class="card" id="hypervisors">
  <h2 class="card__title">Paired hypervisors</h2>
  <p class="card__subtitle">Hypervisors authenticate back to this control plane and surface secure tunnels.</p>

  {% if hypervisors %}
  <div class="table">
    <div class="table__header">
      <span>Agent</span>
      <span>Hostname</span>
      <span>Status</span>
      <span>Capabilities</span>
      <span>Last seen</span>
      <span>Tunnels</span>
    </div>
    {% for hypervisor in hypervisors %}
    <div class="table__row">
      <span class="table__cell table__cell--emphasis">
        <a class="table__link" href="{{ request.url_for('ui_hypervisor', agent_id=hypervisor.agent_id) }}">{{ hypervisor.agent_id }}</a>
      </span>
      <span class="table__cell">{{ hypervisor.hostname }}</span>
      <span class="table__cell">
        <span class="status-pill{% if hypervisor.is_online %} status-pill--success{% else %} status-pill--muted{% endif %}">
          {{ 'Online' if hypervisor.is_online else 'Offline' }}
        </span>
      </span>
      <span class="table__cell">
        {% if hypervisor.capabilities %}
          {{ hypervisor.capabilities | join(', ') }}
        {% else %}
          <span class="text-muted">None reported</span>
        {% endif %}
      </span>
      <span class="table__cell">{{ format_datetime(hypervisor.last_seen) }}</span>
      <span class="table__cell">
        <strong>{{ hypervisor.active_tunnels }}</strong> active
        {% if hypervisor.pending_tunnels %}
          · {{ hypervisor.pending_tunnels }} pending
        {% endif %}
        {% if hypervisor.closed_tunnels %}
          · {{ hypervisor.closed_tunnels }} closed
        {% endif %}
      </span>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="empty-state">
    <h2>No hypervisors connected yet</h2>
    <p>Install and pair a PlayrServers agent to begin managing your infrastructure from this dashboard.</p>
  </div>
  {% endif %}
</section>
{% endblock %}
